---
title: "Velib_july14"
output: html_document
date: "2023-07-16"
---
## Set up
```{r include=FALSE}
# Load any libraries you use in the assignment here
suppressMessages(library(dplyr))
suppressMessages(library(ggplot2))
suppressMessages(library(lubridate))
suppressMessages(library(ggthemes))
suppressMessages(library(tidyverse))
#install.packages("showtext")
suppressMessages(library(showtext))
suppressMessages(library(httr))
library("rvest")
library("xml2")
library("DBI")
library("jsonlite")
library("quanteda")
library("quanteda.textstats")
library("quanteda.textplots")
library("ggrepel")
library(plotly)
#install.packages("ggmap")
library(ggmap)
library(osmdata)
library(sf)
#install.packages("DT")
library(DT)
library(htmltools)

```

## Introduction

**What does one of the world's most famous bikeshares look like, on one of its city's wildest nights? In this project, I  track usage of the Paris Vélib system from 6 PM on Bastille day through to 6 AM the next morning. To do so, I leverage the [excellent open data system](https://opendata.paris.fr/pages/home/) that the Paris Mayor's Office has put in place.** 

## Station Data
```{r}
#Getting data on where stations are 
station_data2<- fromJSON("https://velib-metropole-opendata.smoove.pro/opendata/Velib_Metropole/station_information.json")

station_data <- as_tibble(station_data2$data$stations)
station_data <- station_data %>% 
  select(-stationCode, -rental_methods)
write.csv(station_data, "nyt_climate_data/station_data.csv")



```

**As mentioned, I ran this code over a specific timeframe. I have therefore opted to not have this code evaluated.**

## Function for gathering data
```{r eval=FALSE}
#Creating a function that takes a number of times for the machine to collect data, as well as the rest time in between in seconds
velib_night_function <- function(i, s){
  message(Sys.time())  
  json <- fromJSON(content(GET("https://velib-metropole-opendata.smoove.pro/opendata/Velib_Metropole/station_status.json"), "text"))
    velib_availab1 <- (json)
    velib_prev <- velib_availab1$data$stations

    velib_prev <- velib_prev %>% 
      select(station_id, num_bikes_available, num_docks_available, is_installed, is_renting, is_returning)
    velib_prev <- velib_prev %>% 
      filter(is_installed==1 & is_returning==1 & is_renting==1)
    velib_prev <- velib_prev %>%
      select(-is_installed, -is_renting, -is_returning)
    velib_prev <- rename(velib_prev, "num_bikes_available_prev"=num_bikes_available, "num_docks_available_prev"=num_docks_available)
    Sys.sleep(s)
    a=1

  while (a<=i){
    json <- fromJSON(content(GET("https://velib-metropole-opendata.smoove.pro/opendata/Velib_Metropole/station_status.json"), "text"))
    velib_availab1 <- (json)
    velib_now <- velib_availab1$data$stations

    velib_now <- velib_now %>% 
      select(station_id, num_bikes_available, num_docks_available, is_installed, is_renting, is_returning)
    velib_now <- velib_now %>% 
      filter(is_installed==1 & is_returning==1 & is_renting==1)
    velib_now <- velib_now %>%
      select(-is_installed, -is_renting, -is_returning)
    
    #Generate comparison
    velib_comp <- left_join(velib_prev, velib_now, by="station_id")
    velib_comp$docks_avail_change <- abs(velib_comp$num_docks_available_prev-velib_comp$num_docks_available)
    velib_comp$bikes_avail_change <- abs(velib_comp$num_bikes_available_prev-velib_comp$num_bikes_available)
    velib_comp <- velib_comp %>% 
      select(station_id, docks_avail_change, bikes_avail_change)
    #Adding a time tracker for the time, in Paris (one hour ahead of my system time)
    velib_comp$time_track<- (Sys.time()+hours(1))
    
    #Put just the changes into a new dataframe
    velib_night_tracker <- rbind(velib_night_tracker, velib_comp)

    #Make the now into prev
    velib_prev <-velib_now
    velib_prev <- rename(velib_prev, "num_bikes_available_prev"=num_bikes_available, "num_docks_available_prev"=num_docks_available)
    message(Sys.time())
    a<-a+1
    Sys.sleep(s)
    
  }
  
  return(velib_night_tracker)
}


```

## Runnning it 1500 times, live (Eval=FALSE)
```{r, eval=FALSE}

velib_night_tracker <- data.frame()

#Takes 2 seconds to do, so 58 seconds in between instead of 60
velib_night <- velib_night_function(1500, 58)
write.csv(velib_night, "nyt_climate_data/velib_night.csv")


```

## Reading/writing csvs

```{r}


velib_night <-read.csv("nyt_climate_data/velib_night.csv")
docks_df <- velib_night%>% 
  group_by(station_id)%>%
  summarise(docks_change=sum(docks_avail_change))
bikes_df <- velib_night %>%
  group_by(station_id) %>%
  summarise(bikes_change = sum(bikes_avail_change))
velib_change <- left_join(docks_df, bikes_df, by="station_id")
write.csv(velib_change, "nyt_climate_data/velib_change.csv")


bikes_df %>%
  arrange(desc(bikes_change))%>%
  head()

docks_df %>%
  arrange(desc(docks_change))%>%
  head()



```


## Data overview 
```{r}

velib_change <- read.csv("nyt_climate_data/velib_change.csv")
velib_change <- velib_change %>%
  select(-X)
station_data <- read.csv("nyt_climate_data/station_data.csv")
station_data <- station_data %>%
  select(-X)
velib_night <- read.csv("nyt_climate_data/velib_night.csv")
velib_night <- velib_night %>%
  select(-X)



velib_change <- rename(velib_change, "change_station_id"=station_id)
velib_night <- rename(velib_night, "night_station_id"=station_id)


db <- dbConnect(RSQLite::SQLite(), "nyt_climate_data/velib.sqlite")

dbWriteTable(db, "velib_change", velib_change, overwrite=TRUE)
dbWriteTable(db, "station_data", station_data, overwrite=TRUE)
dbWriteTable(db, "velib_night", velib_night, overwrite=TRUE)

dbGetQuery(db, "SELECT *
           FROM station_Data 
           LIMIT 5
           ")

dbGetQuery(db, "SELECT COUNT(*)
           FROM station_Data 
           LIMIT 5
           ")


dbGetQuery(db, "SELECT *
           FROM velib_change 
           LIMIT 5
           ")
dbGetQuery(db, "SELECT COUNT(*)
           FROM velib_change 
           LIMIT 5
           ")


dbGetQuery(db, "SELECT *
           FROM velib_night 
           LIMIT 5
           ")

dbGetQuery(db, "SELECT COUNT(*)
           FROM velib_night 
           LIMIT 5
           ")

```
**Since a small number of stations weren't in service on Saturday night, the number of rows in tables 1 and 2 are slightly different.** 

## Demonstrating data joining 

```{r}
dbGetQuery(db, "SELECT *
           FROM station_data 
           LEFT JOIN (SELECT *
                      FROM velib_change)
           ON station_id=change_station_id
           ORDER BY bikes_change DESC
           LIMIT 5
           ")


dbGetQuery(db, "SELECT COUNT(*)
           FROM station_data 
           LEFT JOIN (SELECT *
                      FROM velib_change)
           ON station_id=change_station_id
           ORDER BY bikes_change DESC
           ")

dbGetQuery(db, "SELECT *
           FROM velib_night 
           LEFT JOIN (SELECT *
                      FROM station_data)
           ON night_station_id=station_id
           LIMIT 5
           ")


dbGetQuery(db, "SELECT COUNT(*)
           FROM velib_night 
           LEFT JOIN (SELECT *
                      FROM station_data)
           ON night_station_id=station_id
           LIMIT 5
           ")



```

## Map and time options set up
```{r}
bbox_paris <- c(2.2, 48.80, 2.5, 48.92)
map <- get_stamenmap(bbox_paris, zoom=12, maptype="terrain")

bbox_paris_2 <- c(2.16, 48.75, 2.54, 48.952)
map2 <- get_stamenmap(bbox_paris_2, zoom=12, maptype="terrain")

hours_of_day <- c("13:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00", "20:00", "21:00", "22:00", "23:00", "0:00", "1:00", "2:00", "3:00", "4:00", "5:00", "6:00", "7:00", "8:00", "9:00", "10:00", "11:00", "12:00")
```

## Stations that weren't open for at least part of the night

```{r}
#Finding stations that weren't operational
no_bikes <- dbGetQuery(db, "SELECT *
           FROM station_data 
           LEFT JOIN (SELECT *
                      FROM velib_change)
           ON station_id=change_station_id
           WHERE bikes_change IS NULL  
           LIMIT 100
           ")

ggmap(map)+
  geom_point(data=no_bikes, mapping=aes(x=lon, y=lat))+
  #scale_color_distiller(palette = "YlOrRd", direction = 1)+
  labs(title="Map of the Vélib stations that were closed at some point", 
       caption="Source: Vélib API Map data by OpenStreetMap, under ODbL\nMap tiles by Stamen Design, under CC BY 3.0.\nNotes: Data collected from July 14 (13:00 EST) to July 15 (13:00 EST).")+
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank())

ggsave("C:/Users/Peter/OneDrive - London School of Economics/Documents/GitHub/pwyckoff.github.io/images/velib_bastille/closed_stations.png")
```

## Locations of the top 100 stations that night.
```{r}

top_100 <- dbGetQuery(db, "SELECT *
           FROM station_Data 
           LEFT JOIN (SELECT change_station_id, bikes_change
                      FROM velib_change)
           ON station_id=change_station_id
           ORDER BY bikes_change DESC
           LIMIT 100
           ")


#ggmap(map)

ggmap(map)+
  geom_point(data=top_100, mapping=aes(x=lon, y=lat, color=bikes_change))+
  scale_color_distiller(palette = "YlOrRd", direction = 1)+
  labs(title="Map of the top 100 Vélib stations with highest number of bike changes, \nJuly 14-15", 
       caption="Source: Vélib API \nMap tiles by Stamen Design, under CC BY 3.0. \nMap data by OpenStreetMap, under ODbL", 
       color="Bike changes")+
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank())
  

```

**As one can see, most of the stations that got the most use were downtown and in the East of Paris -- which makes sense, this is where the nightlife is, and where people are more likely to bike to get around, as opposed to drive.**

## Areas that saw fewer than 10 movements 
**Whereas this shows the location of the stations that saw fewer than 10 movements overnight. **
```{r}

less_than_ten <- dbGetQuery(db, "SELECT *
           FROM station_Data 
           RIGHT JOIN (SELECT change_station_id, bikes_change
                      FROM velib_change
                      WHERE bikes_change<10)
           ON station_id=change_station_id
           ")

dbGetQuery(db, "SELECT * 
           FROM velib_change
           LIMIT 10")

           
ggmap(map)+
  geom_point(data=less_than_ten, mapping=aes(x=lon, y=lat))+
  labs(title="Map of the Vélib stations that saw fewer than 10 bike moves, \nJuly 14 13:00-July 15 13:00", 
       caption="Source: Vélib API \nMap tiles by Stamen Design, under CC BY 3.0. \nMap data by OpenStreetMap, under ODbL", 
       color="Bike moves")+
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank())     
           
        
```


## Data for all stations in network
**This next, slightly overwhelming charts presents the data for all the stations in the network (minus a few that don't fit on my map).**


```{r}
           
everything <- dbGetQuery(db, "SELECT *
           FROM station_Data 
           LEFT JOIN (SELECT change_station_id, bikes_change
                      FROM velib_change)
           ON station_id=change_station_id
           ")

everything_summarised_by_hour <- velib_night%>% 
  group_by(hour = hour(time_track))%>%
  summarise(sum=sum(docks_avail_change, na.rm=TRUE))

everything_summarised_by_hour$hour<-everything_summarised_by_hour$hour <- paste0(as.character(everything_summarised_by_hour$hour), ":00")

ggplot(everything_summarised_by_hour, aes(x=factor(hour), y=sum))+
  geom_point()+
scale_x_discrete(limits = hours_of_day)+
  labs(title="Evolution of number of bike moves, grouped by hour, for all stations, \nJuly 14 - July 15", 
       caption="Source: Vélib API", 
       x="Hour", 
       y="Number of bike moves")+
  theme_bw()+
  theme(axis.text.x = element_text(size = 6))
  
ggsave("C:/Users/Peter/OneDrive - London School of Economics/Documents/GitHub/pwyckoff.github.io/images/velib_bastille/hourly_total_evolutions.png")

ggmap(map)+
  geom_point(data=everything, mapping=aes(x=lon, y=lat, color=bikes_change))+
  scale_color_distiller(palette = "YlOrRd", direction = 1)+
  labs(title="Map of the Vélib stations by number of bike moves, \nSat Jan 14 22:30- Sun Jan 15 1:00", 
       caption="Source: Vélib API \nMap tiles by Stamen Design, under CC BY 3.0. \nMap data by OpenStreetMap, under ODbL", 
       color="Bike moves")+
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank())   

```


## Data on just top 50 bike stations
**We can also use the data on the top 50 bike stations, to see what the change patterns looked like over a night.**

```{r} 


p<- dbGetQuery(db, "SELECT *
           FROM velib_night 
           WHERE night_station_id IN(SELECT change_station_id
                      FROM velib_change
                      ORDER BY docks_change DESC
                      LIMIT 50)
           ")


summary(p$docks_avail_change)

p$time_track <- ymd_hms(p$time_track)

p$hour <- hour(p$time_track)

p2 <- p


p3 <- p2 %>% 
  group_by(night_station_id, hour) %>%
  summarise(sum=sum(docks_avail_change))

p3$hour <- paste0(as.character(p3$hour), ":00")



ggplot(p3, aes(x=factor(hour), y=sum))+
  geom_point(color="#2f4b7c")+
scale_x_discrete(limits = c("13:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00", "20:00", "21:00", "22:00", "23:00", "0:00", "1:00", "2:00", "3:00", "4:00", "5:00", "6:00", "7:00", "8:00", "9:00", "10:00", "11:00", "12:00"))+
  labs(title="Evolution of number of bike moves grouped by hour, for top 20 stations, \nJuly 14 - July 15", 
       caption="Source: Vélib API", 
       x="Hour", 
       y="Number of bike moves by hour")+
  theme_bw()+
theme(axis.text.x = element_text(size = 6))+
  stat_summary(
    geom = "point",
    fun.y = "mean",
    color = "#bc5090", 
    size = 3,
    shape = 18,
  )


p3 %>% 
  filter(hour=="23:00")%>%
  arrange(desc(sum))

station_data %>% 
  filter(station_id==128884445)
```
**This highlights a significant amount of usage throughout the afternoon and evening, dipping most around 21:00/22:00. Past 1 AM, the numbers drop even more, before picking up again the following morning. Constantine-Université, right by the Invalides, saw the most changes of any one hour, with 65 changes, or more than one a minute.**


## Bike usage as a share of capacity ("strain")
**Finally, we can also look at calculate usage metrics as a share of total bike capacity at each station** 
```{r}

capacity_df <- dbGetQuery(db, "SELECT *
           FROM station_data 
           LEFT JOIN (SELECT *
                      FROM velib_change)
           ON station_id=change_station_id
           ")

capacity_df$usage <- capacity_df$docks_change/capacity_df$capacity*100

print(paste0("The correlation between number of bike changes and station usage is ", cor(capacity_df$bikes_change, capacity_df$usage, method="pearson", use="complete.obs")))

ggmap(map)+
  geom_point(data=capacity_df%>%filter(usage!="NA"), mapping=aes(x=lon, y=lat, color=usage, size=bikes_change))+
  scale_color_distiller(palette = "YlOrRd", direction = 1)+
    scale_size(range=c(0.25, 2.0))+
  labs(title="Map of Vélib' stations by number of bikes \nused over 24 hours as a share of capacity", 
       caption="Source: Vélib API Map data by OpenStreetMap, under ODbL\nMap tiles by Stamen Design, under CC BY 3.0.\nNotes: Data collected from July 14 (13:00 EST) to July 15 (13:00 EST).", 
       color="Station strain", 
       size="Bikes used")+
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank())   

ggsave("C:/Users/Peter/OneDrive - London School of Economics/Documents/GitHub/pwyckoff.github.io/images/velib_bastille/strain_usage_24hours.png")


#Not using the following: 
# ggmap(map)+
#   geom_point(data=capacity_df%>%filter(bikes_change!="NA"), mapping=aes(x=lon, y=lat, color=bikes_change), size=1)+
#   scale_color_distiller(palette = "YlOrRd", direction = 1)+
#   labs(title="Map of Vélib' stations by number of bikes over 24 hours", 
#        caption="Source: Vélib API Map data by OpenStreetMap, under ODbL\nMap tiles by Stamen Design, under CC BY 3.0.\nNotes: Data collected from July 14 (13:00 EST) to July 15 (13:00 EST).", 
#        color="Bikes used")+
#   theme(axis.line=element_blank(),
#       axis.text.x=element_blank(),
#       axis.text.y=element_blank(),
#       axis.ticks=element_blank(),
#       axis.title.x=element_blank(),
#       axis.title.y=element_blank())   

#ggsave("C:/Users/Peter/OneDrive - London School of Economics/Documents/GitHub/pwyckoff.github.io/images/velib_bastille/usage_24hours.png")
capacity_df%>% filter(usage>1000)

ggmap(map)+
  geom_point(data=capacity_df%>%filter(usage!="NA")%>%filter(usage>1000), mapping=aes(x=lon, y=lat, color=usage, size=bikes_change))+
  scale_color_distiller(palette = "YlOrRd", direction = 1)+
    scale_size(range=c(0.25, 2.0))+
  labs(title="Map of Vélib' stations with over 1000% station strain in 24 hours", 
       caption="Source: Vélib API Map data by OpenStreetMap, under ODbL\nMap tiles by Stamen Design, under CC BY 3.0.\nNotes: Data collected from July 14 (13:00 EST) to July 15 (13:00 EST).", 
       color="Station strain", 
       size="Bikes used")+
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank())   

ggsave("C:/Users/Peter/OneDrive - London School of Economics/Documents/GitHub/pwyckoff.github.io/images/velib_bastille/top_strain_usage_24hours.png")


```
**There is a high correlation between the two variables, but usage does suggest a slightly different picture, since some smaller stations may have been constrained by the number of bikes they could offer to riders. A number of stations experiencing their total capacity of bikes coming and going in just those 2.5 hours! They still tend to be in the center and towards the East, and you can even somewhat see the angle of the Grands Boulevards stations in the North.** 



## Longitude, Latitude
**I'll conclude by using usage to see if there any trends by longitude or latitude.**



```{r}

ggplot(data=capacity_df, aes(x=lon, y=usage))+
  geom_point(aes(color=usage))+
  geom_smooth(color="#bc5090")+
  labs(title="Station usage by longitude", 
       caption="Source: Vélib API\nNotes: Data collected from July 14 (13:00 EST) to July 15 (13:00 EST).", 
       color="Bike usage", 
       x="Longitude", 
       y="Usage")+
  theme_bw()

ggsave("C:/Users/Peter/OneDrive - London School of Economics/Documents/GitHub/pwyckoff.github.io/images/velib_bastille/longitude.png")
  
ggplot(data=capacity_df, aes(x=lat, y=usage))+
  geom_point(aes(color=usage))+
  coord_flip()+
  geom_smooth(color="#bc5090")+
  labs(title="Station usage by latitude", 
       caption="Source: Vélib API\nNotes: Data collected from July 14 (13:00 EST) to July 15 (13:00 EST).", 
       color="Bike usage", 
       x="Latitude", 
       y="Usage")+
  theme_bw()

ggsave("C:/Users/Peter/OneDrive - London School of Economics/Documents/GitHub/pwyckoff.github.io/images/velib_bastille/latitude.png")

top_stations_df <- capacity_df %>% arrange(desc(usage))%>% head(10)

write.csv(top_stations_df, "top_stations_2.csv")
```
**For both latitude and longitude, it is clear that central locations were more popular on Saturday night.**

**This project has therefore more or less confirmed priors about how centrality in Paris would affect usage of bikes. And though our method of sampling likely undercounts total rides by only sampling status changes every minute, it still finds a sizable number of trips conducted.**

```{r}
sum(velib_change$docks_change, na.rm=TRUE)

```

**Indeed, the total number of dock changes was over 187,000, which suggests at least 90,000 trips were conducted over the day. **


## Fireworks 
```{r}



all_data <- dbGetQuery(db, "SELECT *
           FROM velib_night 
           LEFT JOIN (SELECT *
                      FROM station_data)
           ON night_station_id=station_id
           ")


all_data$time_track <- ymd_hms(all_data$time_track)

all_data$hour <- hour(all_data$time_track)

all_data_summarised <- all_data %>% 
  group_by(night_station_id, lat, lon, name, capacity, hour) %>%
  summarise(sum=sum(docks_avail_change))

all_data_summarised$hour <- paste0(as.character(all_data_summarised$hour), ":00")
all_data_summarised$usage <- all_data_summarised$sum/all_data_summarised$capacity*100.0


# Violin Plot
ggplot(all_data_summarised, aes(x=factor(hour), y=sum))+
  geom_violin(color="#2f4b7c")+
scale_x_discrete(limits = c("13:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00", "20:00", "21:00", "22:00", "23:00", "0:00", "1:00", "2:00", "3:00", "4:00", "5:00", "6:00", "7:00", "8:00", "9:00", "10:00", "11:00", "12:00"))+
  labs(title="Evolution of number of bike moves grouped by hour, for all stations, \nJuly 14 - July 15", 
       caption="Source: Vélib API", 
       x="Hour", 
       y="Number of bike moves by hour")+
  theme_bw()+
theme(axis.text.x = element_text(size = 6))+
  stat_summary(
    geom = "point",
    fun.y = "mean",
    color = "#bc5090", 
    size = 3,
    shape = 18,
  )

ggsave("C:/Users/Peter/OneDrive - London School of Economics/Documents/GitHub/pwyckoff.github.io/images/velib_bastille/violin_plots.png")


hours_of_day <- c("13:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00", "20:00", "21:00", "22:00", "23:00", "0:00", "1:00", "2:00", "3:00", "4:00", "5:00", "6:00", "7:00", "8:00", "9:00", "10:00", "11:00", "12:00")
```


```{r}
#Hourly 
for (specific_hour in hours_of_day){
  ggmap(map)+
  geom_point(data=all_data_summarised %>% filter(hour==specific_hour), mapping=aes(x=lon, y=lat, color=sum), size=1)+
  scale_color_distiller(palette = "YlOrRd", direction = 1, limits=c(0, 65))+
  labs(title="Map of all changes", 
       subtitle=specific_hour, 
       caption="Source: Vélib API \nMap tiles by Stamen Design, under CC BY 3.0. \nMap data by OpenStreetMap, under ODbL", 
       color="Bike usage")+
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank()) 
  ggsave(paste0("nyt_climate_data/hourly_maps/maps_", hour(hm(specific_hour)), ".png"))
}
```

### Hourly Dark Usage

```{r}
all_data_summarised$color_levels <- ifelse(all_data_summarised$usage>=100, "over 100", ifelse(all_data_summarised$usage<100&all_data_summarised$usage>=50, "between 50 and 100", ifelse(all_data_summarised$usage<50&all_data_summarised$usage>=30, "between 30 and 50", ifelse(all_data_summarised$usage<30&all_data_summarised$usage>=20, "between 20 and 30", ifelse(all_data_summarised$usage<20&all_data_summarised$usage>=10, "between 10 and 20", NA)))))
all_data_summarised$color <- with(all_data_summarised, dplyr::case_when(color_levels == "above 100" ~ "#ff6361", color_levels == "between 50 and 100" ~ "#ffa600",color_levels == "between 30 and 50" ~ "#bc5090",color_levels == "between 20 and 30" ~ "#58508d",color_levels == "between 10 and 20" ~ "#ff6361"))


max(all_data_summarised$lon)

#Figuring out bin sizes
all_data_summarised_nozero <- all_data_summarised %>% filter(usage!=0)
summary(all_data_summarised_nozero$usage)
ggplot(all_data_summarised_nozero, aes(x=usage)) + geom_histogram(binwidth=.5)


```



### Hourly Usage

```{r}

# 
# for (specific_hour in hours_of_day){
#   ggmap(map)+
#   geom_point(data=all_data_summarised %>% filter(hour==specific_hour), mapping=aes(x=lon, y=lat, fill=usage), size=1)+
#   scale_fill_distiller(palette = "YlOrRd", direction = 1, limits=c(0, 200))+
#   labs(title="Map of all changes", 
#        subtitle=specific_hour, 
#        caption="Source: Vélib API \nMap tiles by Stamen Design, under CC BY 3.0. \nMap data by OpenStreetMap, under ODbL", 
#        color="Bike usage")+
#   theme(axis.line=element_blank(),
#       axis.text.x=element_blank(),
#       axis.text.y=element_blank(),
#       axis.ticks=element_blank(),
#       axis.title.x=element_blank(),
#       axis.title.y=element_blank()) 
#   ggsave(paste0("nyt_climate_data/strain_maps/maps_", hour(hm(specific_hour)), ".png"))
# }
# 
# ggmap(map)+
#   geom_point(data=all_data_summarised %>% filter(hour=="13:00"), mapping=aes(x=lon, y=lat, color=sum), size=1.5)+
#   scale_color_distiller(palette = "YlOrRd", direction = 1)+
#   labs(title="Map of all changes", 
#        subtitle="13:00", 
#        caption="Source: Vélib API \nMap tiles by Stamen Design, under CC BY 3.0. \nMap data by OpenStreetMap, under ODbL", 
#        color="Bike usage")+
#   theme(axis.line=element_blank(),
#       axis.text.x=element_blank(),
#       axis.text.y=element_blank(),
#       axis.ticks=element_blank(),
#       axis.title.x=element_blank(),
#       axis.title.y=element_blank())   
# 
# ```
# 
# ### Hourly Dark Total Numbers
# ```{r}
# #Figuring out binning for usage
# 
# summary(all_data_summarised_nozero$sum)
# ggplot(all_data_summarised_nozero, aes(x=sum)) + geom_histogram(binwidth=.5)
# 
# all_data_summarised$total_number_color_levels <- ifelse(all_data_summarised$sum>=30, "over 30", ifelse(all_data_summarised$sum<30&all_data_summarised$sum>=10, "between 10 and 30", ifelse(all_data_summarised$sum<10&all_data_summarised$sum>=5, "between 5 and 10",  ifelse(all_data_summarised$sum<5&all_data_summarised$sum>=3, "between 3 and 5", NA))))
# 
# all_data_summarised$total_number_color_levels <- factor(all_data_summarised$total_number_color_levels, levels=c("between 3 and 5", "between 5 and 10", "between 10 and 30", "over 30", "NA"))
# levels(all_data_summarised$total_number_color_levels)
# table(all_data_summarised$color_levels)

```
#LIGHT 
```{r}
for (specific_hour in hours_of_day){
  ggmap(map2)+  
    geom_point(data=all_data_summarised %>%
                 filter(hour==specific_hour)%>%
                 filter(total_number_color_levels!="NA"),
               mapping=aes(x=lon, y=lat,
                           color=total_number_color_levels,
                           size=total_number_color_levels))+
  scale_color_manual(name = "Bike usage", labels= c("between 3 and 5", "between 5 and 10", "between 10 and 30", "over 30"), values=c("#003f5c", "#bc5090", "#ff6361", "#ffa600"))+
  scale_size_manual(name="Bike usage", labels= c("between 3 and 5", "between 5 and 10", "between 10 and 30", "over 30"), values = c(0.75, 1, 1.5, 2.5))+
  labs(title="Number of bike changes by station", 
       subtitle=specific_hour, 
       caption="Source: Vélib API Map tiles by Stamen Design, under CC BY 3.0. \nMap data by OpenStreetMap, under ODbL \nNotes: Data collected from July 14 (13:00 EST) to July 15 (13:00 EST). \nStations were included if they saw at least 3 bike changes that hour.", 
       color="Bike usage")+
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank())

  ggsave(paste0("nyt_climate_data/hourly_totalnumbers_maps_light/maps_", hour(hm(specific_hour)), ".png"))
}

#Hourly fireworks Strain 
all_data_summarised_aboveten <- 
table(all_data_summarised_aboveten$color_levels)
for (specific_hour in hours_of_day){
  ggmap(map2)+
  geom_point(data=all_data_summarised %>% filter(usage>=10)%>% filter(hour==specific_hour) %>% filter(color_levels!="NA"), aes(x=lon, y=lat, color=color_levels, size=color_levels))+
  scale_color_manual(name="Station strain", labels= c("between 10 and 20", "between 20 and 30", "between 30 and 50", "between 50 and 100", "over 100"), values = c("#003f5c", "#006583", "#008d91", "#00b481", "#57d657"))+
  scale_size_manual(name="Station strain", labels= c("between 10 and 20", "between 20 and 30", "between 30 and 50", "between 50 and 100", "over 100"), values = c(0.5, 0.75, 1, 1.5, 2.5))+
  #scale_color_distiller(palette = "YlOrRd", direction = 1, limits=c(0, 65))+
  #scale_fill_viridis_c(option = "magma", limits=c(0, 65))+
  labs(title="Station usage for the hour, as a share of station capacity (station strain)", 
       subtitle=specific_hour, 
       caption="Source: Vélib API.\nNotes: Data collected from July 14 (13:00 EST) to July 15 (13:00 EST).\nStations were included if they had at least 10% of their capacity used.", 
       color="Bike usage")+
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank())
  ggsave(paste0("nyt_climate_data/hourly_strain_maps_light/maps_", hour(hm(specific_hour)), ".png"))
}



```



# DARK 
```{r}
#Hourly fireworks usage
for (specific_hour in hours_of_day){
  ggplot()+
  geom_point(data=all_data_summarised %>% filter(hour==specific_hour)%>% filter(total_number_color_levels!="NA"), mapping=aes(x=lon, y=lat, color=total_number_color_levels, size=total_number_color_levels))+
  scale_color_manual(values = c("#003f5c", "#bc5090", "#ff6361", "#ffa600"))+
  scale_size_manual(values = c(0.75, 1, 1.5, 2.5))+
  labs(title="Number of bike changes by station", 
       subtitle=specific_hour, 
       caption="Source: Vélib' API. \nNotes: Data collected from July 14 (13:00 EST) to July 15 (13:00 EST). \nStations were included if they saw at least 3 bike changes that hour.", 
       color="Bike usage")+
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      legend.position = "none", 
      panel.background = element_rect(fill = "black",
                                colour = NA,
                                size = 0.5, linetype = "solid"),
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank())+
    xlim(2.16, 2.54)+
    ylim(48.75, 48.952)
  ggsave(paste0("nyt_climate_data/hourly_totalnumbers_maps_dark/maps_", hour(hm(specific_hour)), ".png"))
}

#Hourly fireworks Strain 
all_data_summarised_aboveten <- 
table(all_data_summarised_aboveten$color_levels)
for (specific_hour in hours_of_day){
  ggplot()+
  geom_point(data=all_data_summarised %>% filter(usage>=10)%>% filter(hour==specific_hour) %>% filter(color_levels!="NA"), aes(x=lon, y=lat, color=color_levels, size=color_levels))+
  scale_color_manual(values = c("#003f5c", "#006583", "#008d91", "#00b481", "#57d657"))+
  scale_size_manual(values = c(0.5, 0.75, 1, 1.5, 2.5))+
  #scale_color_distiller(palette = "YlOrRd", direction = 1, limits=c(0, 65))+
  #scale_fill_viridis_c(option = "magma", limits=c(0, 65))+
  labs(title="Station usage for the hour, as a share of station capacity", 
       subtitle=specific_hour, 
       caption="Source: Vélib API.\nNotes: Data collected from July 14 (13:00 EST) to July 15 (13:00 EST).\nStations were included if they had at least 10% of their capacity used.", 
       color="Bike usage")+
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      legend.position = "none",
      panel.background = element_rect(fill = "black",
                                colour = NA,
                                size = 0.5, linetype = "solid"),
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank())+
  xlim(2.16, 2.54)+
  ylim(48.75, 48.952)
  ggsave(paste0("nyt_climate_data/hourly_strain_maps_dark/maps_", hour(hm(specific_hour)), ".png"))
}




```

#sortable table
```{r}
#sortable table 
sortable_table <- capacity_df%>% select(name, capacity, bikes_change, usage, lat, lon, -station_id, -change_station_id, -docks_change)%>%arrange(desc(bikes_change))

names(sortable_table) <- c("Name", "Capacity", "Number of bike changes", "Strain", "Latitude", "Longitude")

sortable_table_html <- DT::datatable(sortable_table, 
              extensions = 'Buttons',
              options = list(dom = 'Blfrtip',
                             buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                               lengthMenu = list(c(10,25,50,-1),
                                                 c(10,25,50,"All"))))

save_html(sortable_table_html, "C:/Users/Peter/OneDrive - London School of Economics/Documents/GitHub/pwyckoff.github.io/images/velib_bastille/sortable_table.html", background="white", libdir="lib", lang="en")
```