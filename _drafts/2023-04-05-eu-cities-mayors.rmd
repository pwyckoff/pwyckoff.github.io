---
title: "city_mayors"
output: html_document
date: "2023-04-05"
---

```{r setup, include=FALSE}
suppressMessages(library("tidyverse"))
suppressMessages(library("rvest"))
suppressMessages(library(ggthemes))
suppressMessages(library(ggrepel))
suppressMessages(library(plotly))
suppressMessages(library(sf))
suppressMessages(library(leaflet))
suppressMessages(library(scales))
suppressMessages(library(ggthemes))
suppressMessages(library(formattable))
```


Who runs large EU cities? 
Using data scraped from wikipedia, I find that 


Cities represent a growing Big European cities are doing well, growing economically and demographically. Between 2000 and 2013, EU cities registered 50% higher GDP growth than the rest of the EU. Their employment rose by 7% even as it declined slightly elsewhere. Urban residents have increased to 75% of the EU population. Cities will continue growing for interwoven reasons: their profitable status as centres for specialization, globalization and innovation; the sustainable, connected lifestyle they offer; and their perennial ability to attract young people. Unaffordable housing and terrorist threats are some of the many challenges big city mayors face. But control of these cities affords centre-left parties the ability to burnish their brands with a growing, younger and wealthier slice of the electorate. 


In this article, I set out to assess what parties are in control of the largest cities in Europe. 


In 2022, the _Parti Socialiste_ came in a bruising sixth place, with only 1.75% of the vote in the first round of the French Presidential election. The _Parti Socialiste_ candidate in 2022 was Anne Hidalgo, the Paris mayor. Her loss in the presidential campaign stands in stark contrast with her dominant re-election as mayor in 2020, where her _Paris en commun_ list came first by a substantial majority in the first round, and where she now oversees a coalition that has 94 of the 164 Council of Paris seats.


Who governs I set out to try and scrape data on the the population of the largest European cities, and then link through to get data on what mayors they have, and their associated political parties. 

**First I went through and pulled the data on the largest EU cities by population, as well as data on the associated country, and then the links for each city's wikipedia page. **

```{r}
# Getting data on city populations
url <- "https://en.wikipedia.org/wiki/List_of_cities_in_the_European_Union_by_population_within_city_limits"
mytable <- read_html(url) %>% html_nodes("table") %>% .[[1]] 
table_pop <- mytable %>% html_table()
#table_pop <- html_table(html_pop, fill=TRUE)[1]
table_pop <- as.data.frame(table_pop)
colnames(table_pop)<- c("rank", "city", "country", "pop", "date", "ref", "photo")
table_pop <- table_pop %>%
  select(rank, city, country, pop, date)


#some help from here: https://stackoverflow.com/questions/37187976/scrape-urls-from-a-wikipedia-table 
get_link <- function(html_table, city){
  html_table %>% 
    html_nodes(xpath=paste0("//a[text()='", city, "']")) %>% 
    .[[1]] %>% 
    html_attr("href")
}

table_pop$url <- sapply(table_pop$city, function(x)get_link(mytable, x))
head(table_pop)


#Fascinating that city names can end up looking quite intense due to accents, etc.
table_pop$url <- sub("^", "https://en.wikipedia.org", table_pop$url)

#Adding correct link for Copenhagen (wiki link sends to capital region, not municipality)
table_pop["url"][table_pop["url"]=="https://en.wikipedia.org/wiki/Copenhagen"] <- "https://en.wikipedia.org/wiki/Copenhagen_Municipality"
nrow(table_pop)

```

**I then used those links to identify information on mayors for each city, as well as their party, and then cleaned the data, correcting where necessary. I also scraped longitude and latitude data for each city from the wikipedia page**

```{r}
# Getting data on city mayors, and associated party

city_list <- data.frame(c())
lat_list <- data.frame(c())
long_list <- data.frame(c())


for (i in table_pop$url){
  html_city <- read_html(i)
  city_data <- html_text(html_elements(html_city, css = ".infobox-data"))
  city_temp<-str_extract(city_data, ("[A-Z]{1}[a-ú]+.+\\s[A-Z]{1}.+\\s\\([A-Z]{1}.*\\)"))
  city_temp<- city_temp[city_temp!="character(0)"]
  city_temp<- city_temp[!is.na(city_temp)]
  city_temp<- city_temp[1]
  #print(city_temp)
  city_list<-rbind(city_list, city_temp[1])
  lat_data <- html_text(html_elements(html_city, css = ".latitude"))
  lat_temp<- lat_data[1]
  #print(lat_temp)
  lat_list<-rbind(lat_list, lat_temp[1])
  long_data <- html_text(html_elements(html_city, css = ".longitude"))
  long_temp<- long_data[1]
  #print(long_temp)
  long_list<-rbind(long_list, long_temp[1])
}


colnames(city_list)<-"mayor"
city_list<- as.data.frame(city_list)

table_pop$mayor <- city_list[[1]]
table_pop$lat <-lat_list[[1]]
table_pop$long <-long_list[[1]]


#view(table_pop)

#Note that I checked by hand for the cities that did not have a mayor listed (in all cases because there was no party affiliation listed -- affiliation (or lack of) added by hand)
all_data <- table_pop
all_data$mayor[all_data$city=="Wrocław"] <- "Jacek Sutryk (non-partisan, but Civic Coalition)"
all_data$mayor[all_data$city=="Riga"] <- "Mārtiņš Staķis (Independent)"
all_data$mayor[all_data$city=="Gothenburg"] <- "Jonas Attenius (Swedish Social Democratic Party)"
all_data$mayor[all_data$city=="Vilnius"] <- "Remigijus Šimašius (Freedom Party)"
all_data$mayor[all_data$city=="Genoa"] <- "Marco Bucci (Indep, Right-Wing)"
all_data$mayor[all_data$city=="Lisbon"] <- "Carlos Moedas (PSD)"
all_data$mayor[all_data$city=="Bratislava"] <- "Matúš Vallo (Independant - Team Bratislava)"
all_data$mayor[all_data$city=="Tallinn"] <- "Mihhail Kõlvart (Estonian Centre Party)"
all_data$mayor[all_data$city=="Lublin"] <- "Krzysztof Żuk (Civic Platform)"
all_data$mayor[all_data$city=="Kaunas"] <- "Visvaldas Matijošaitis (Independent)"
all_data$mayor[all_data$city=="Turin"] <- "Stefano Lo Russo (PD)"
all_data$mayor[all_data$city=="Aarhus"] <- "Jacob Bundsgaard (S)"
all_data$mayor[all_data$city=="Alicante"] <- "Luis Barcala Sierra (PP)"


all_data$party <- sapply(str_extract_all(all_data$mayor, "(?<=\\()[^)(]+(?=\\))"), paste0, collapse =",")
all_data$mayorname <- str_extract(all_data$mayor, ".+?(?=\\()")
all_data$mayorname <- gsub("\\[1\\]", "", all_data$mayorname)
all_data$mayorname <- gsub("\\[2\\]", "", all_data$mayorname)
all_data$mayorname <- gsub("\\[3\\]", "", all_data$mayorname)


countries_abb <- read.csv("countries.csv")
all_data <- left_join(all_data, countries_abb, by="country")
colnames(all_data)[which(names(all_data) =="Alpha.2.code")]<-"ctry"
all_data$ctry[all_data$country=="Netherlands"] <- "NL"
all_data$ctry[all_data$country=="Czech Republic"] <- "CZ"


all_data$yr <- substr(all_data$date, nchar(all_data$date)-4+1, nchar(all_data$date))
all_data$yr <- as.numeric(all_data$yr)
#all_data$ctry_yr <- paste(all_data$ctry, "-", all_data$yr)

all_data$pop <- as.numeric(gsub(",", "", all_data$pop))

write.csv(all_data, "all_data.csv", row.names = TRUE)

```


**I then merge data about the national parties into the overall data, including their EU Parliament affiliation, and the right-left indicator for their most recent manifesto in the  [Manifesto Project](https://manifesto-project.wzb.eu/). I also added each mayor's gender.**


```{r}
party_positions <- read.csv("rile.csv")


all_data$party_eu<-party_positions$party_eu
all_data$rile <- party_positions$rile
all_data$gender <- party_positions$gender


write.csv(all_data, "all_data.csv", row.names = TRUE)

```
**I converted the latitude/longitude indicators from wikipedia into a coherent decimal system.** 

```{r}
#Convert latitude and longitude to decimal 
all_data <- read.csv("all_data.csv")

all_data$lat1 <- as.numeric(str_extract(all_data$lat, "[0-9]{1,2}"))
all_data$lat2 <-as.numeric(str_extract(substr(all_data$lat, 4, 5), "[0-9]{1,2}"))
all_data$long1 <- as.numeric(str_extract(all_data$long, "[0-9]{1,2}"))
all_data$long2 <-as.numeric(str_extract(substr(all_data$long, 3, 5), "[0-9]{1,2}"))
all_data$long3 <- substr(str_extract(all_data$long, "[\\″\\′][WE]{1}"), 2, 2)
all_data$lat_num <- all_data$lat1 + all_data$lat2/60
all_data$long_num <- ifelse(all_data$long3=="E", all_data$long1+all_data$long2/60, -(all_data$long1+all_data$long2/60))


```

**I then start to produce some figures. The first figure shows that some  parties have a much larger number of major mayors in the EU. Greens and S&D mayors also tend to have the larger cities (the averages are displayed in green), among major cities. **

```{r}

#General idea of the distribution of parties
all_data_mean<- all_data %>%
  group_by(party_eu)%>%
  summarize(pop_party= mean(pop))

ggplot (all_data) +
  geom_jitter(data=all_data, aes(party_eu, pop), width=0.2)+
  geom_point(data=all_data_mean, aes(party_eu, pop_party), color="#00FF7F", shape=18, size=3)+
  scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) +
  theme_bw()+
  labs(title="The population of major cities in the EU, grouped by mayor's \nPolitical Party/EU Affiliation in the EU, latest data",
         subtitle = "Source: Wikipedia")+
  xlab("Mayor's Political Party/EU Affiliation")+
  ylab("Population")


table(all_data$party_eu)

all_data %>% 
  group_by(party_eu)%>%
  summarise(sum(pop))

```

**I then produce a map, using traditional EU Party Colors for each mayor's political party, and with circle sizes varying with population. Scrolling with ggplotly also allows you to see the name of the mayor, and their national political party affiliation. **

```{r}
#Mapping
europe <-map_data("world", ylim=c(33,60), xlim=c(-10,27)) 

#colors for EU parties taken from: https://observablehq.com/@joshrayman/eu-parliament-hex-map 

p2<- ggplot() +
    geom_polygon(data = europe, aes(x=long, y = lat, group = group), fill="gray88", colour = "grey60", alpha=0.5) +
    geom_point(data=all_data, aes(x=long_num, y=lat_num, size=pop, color=party_eu, text = paste("City -- Mayor: ", city, "--", mayorname)))+
    scale_color_manual(values = c("#0054A5", "#3399ff", "#32CD32", "#999999", "gold", "#F0001C"))+
    scale_size_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) +
    #scale_size_binned() +
    #scale_alpha(range=c(0.3, 0.8))+
    labs(title="Major City Mayors by Political Party/EU Affiliation in the EU, latest data",
         subtitle = "Source: Wikipedia")+
    coord_quickmap()+
    theme_void()
    #theme(legend.position = "right", plot.subtitle = element_text(size=8))

p2
ggplotly(p2)

```
**The Right-Left (rile) scale was only available for some parties, and not for independents, but provides a clear reminder that most cities in Europe are electing moderate or left-wing party mayors.**

```{r}


p4<- ggplot() +
    geom_polygon(data = europe, aes(x=long, y = lat, group = group), fill="gray88", colour = "grey60", alpha=0.5) +
    geom_point(data=all_data, aes(x=long_num, y=lat_num, size=pop, color=rile, text = paste("City -- Mayor: ", city, "--", mayorname)))+
    scale_color_gradient2()+
    scale_size_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) +
    #scale_size_binned() +
    #scale_alpha(range=c(0.3, 0.8))+
    labs(title="Major EU City Mayors by their party's right-left scale, latest data",
         subtitle = "Source: Wikipedia, Manifesto Project")+
    coord_quickmap()+
    theme_void()
    #theme(legend.position = "right", plot.subtitle = element_text(size=8))
p4

ggplotly(p4)

```

**I made a chart by gender -- noting the considerable glass ceiling that remains for mayors in Europe.**

```{r}
#I used the colors The Economist used in this article to avoid classic gender binary colors https://www.economist.com/leaders/2018/04/07/how-to-narrow-britains-gender-pay-gap. 

p3<- ggplot() +
    geom_polygon(data = europe, aes(x=long, y = lat, group = group), fill="gray88", colour = "grey60", alpha=0.5) +
    geom_point(data=all_data, aes(x=long_num, y=lat_num, size=pop, color=gender, text = paste("City -- Mayor: ", city, "--", mayorname)))+
    scale_color_manual(values = c(rgb(241, 95, 68, maxColorValue = 255), rgb(16, 143, 138, maxColorValue=255)))+
    scale_size_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) +
    #scale_size_binned() +
    #scale_alpha(range=c(0.3, 0.8))+
    labs(title="Major City Mayors' by Gender in the EU, latest data",
         subtitle = "Source: Wikipedia")+
    coord_quickmap()+
    theme_void()
    #theme(legend.position = "right", plot.subtitle = element_text(size=8))

p3

ggplotly(p3)

```
**And if we add to this metrics about the share of major mayoralties by party and by gender, we see significant discrepancies.**

```{r}
#I used the colors The Economist used in this article to avoid classic gender binary colors https://www.economist.com/leaders/2018/04/07/how-to-narrow-britains-gender-pay-gap. 

all_data_gender<- all_data %>%
  group_by(party_eu, gender)%>%
  summarise(cnt=n())%>%
  mutate(freq= formattable::percent(cnt/sum(cnt)))

p3<- ggplot() +
    geom_point(data=all_data_gender%>%
                 filter(gender=="F"), aes(x=party_eu, y=freq))+
    scale_color_manual(values = c(rgb(241, 95, 68, maxColorValue = 255), rgb(16, 143, 138, maxColorValue=255)))+
    scale_size_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) +
    labs(title="Share of Major City Mayors that are women in the EU, by party latest data",
         subtitle = "Source: Wikipedia")+
  xlab("Mayor's Political Party/EU Affiliation")+
  ylab("Share of major mayors who are women")+
  theme_bw()

p3

```


**National institutions often get most of the attention when it comes to political victories. Still, cities often play a crucial role of building a stable of potential nation-level politicians -- and highlight a  different spectrum of political players. **
